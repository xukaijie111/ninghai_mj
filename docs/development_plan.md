# 宁海麻将开发计划

## 项目概述
开发一个基于Cocos Creator的宁海麻将游戏系统，包含Node.js服务端和网页客户端，支持在微信中运行。

## 技术栈选择
- **客户端**: Cocos Creator 3.8+ + TypeScript + WebSocket (Web平台)
- **服务端**: Node.js + Express + Socket.io + MongoDB + Redis
- **部署**: Docker + Nginx + PM2 + 阿里云ECS
- **微信集成**: 微信公众号网页授权 + 微信JS-SDK
- **开发工具**: VS Code + 微信开发者工具

## 项目特点分析
1. **实时性要求高**: 多人在线对战，需要低延迟通信
2. **状态同步复杂**: 游戏状态需要在多个客户端间同步
3. **规则复杂**: 宁海麻将有特殊规则和计分系统
5. **防作弊**: 需要服务端验证所有游戏操作

## 开发阶段规划

### 第一阶段：项目搭建与基础架构（2周）

#### 1.1 环境准备与项目初始化
**时间**: 2-3天
- [ ] 安装开发环境（Node.js, MongoDB, Cocos Creator, 微信开发者工具）
- [ ] 创建Git仓库和分支策略
- [ ] 创建Cocos Creator项目（配置TypeScript）
- [ ] 初始化Node.js服务端项目结构
- [ ] 配置ESLint、Prettier代码规范
- [ ] 编写项目README和开发文档

#### 1.2 服务端基础架构
**时间**: 4-5天
- [ ] Express服务器基础搭建
- [ ] MongoDB数据库设计和连接
- [ ] Redis缓存系统配置
- [ ] Socket.io实时通信框架
- [ ] JWT认证中间件
- [ ] 日志系统（Winston）
- [ ] 错误处理中间件
- [ ] API限流和安全配置
- [ ] 环境变量配置

#### 1.3 客户端基础架构
**时间**: 4-5天
- [ ] Cocos Creator项目结构规划
- [ ] TypeScript配置和类型定义
- [ ] 场景管理器（SceneManager）
- [ ] 网络通信管理器（NetworkManager）
- [ ] 资源管理器（ResourceManager）
- [ ] 音效管理器（AudioManager）
- [ ] UI管理器（UIManager）
- [ ] 数据管理器（DataManager）
- [ ] 事件系统（EventManager）
- [ ] 断线重连管理器（ReconnectManager）
- [ ] 状态同步管理器（StateSyncManager）

#### 1.4 开发工具配置
**时间**: 1-2天
- [ ] 配置热重载开发环境
- [ ] 设置调试工具和断点
- [ ] 配置构建脚本
- [ ] 设置测试框架

### 第二阶段：核心游戏逻辑（3周）

#### 2.1 数据模型和数据库设计
**时间**: 3-4天
- [ ] 设计用户数据模型（用户信息、统计数据）
- [ ] 设计房间数据模型（房间配置、玩家列表）
- [ ] 设计游戏状态数据模型（牌局状态、玩家手牌）
- [ ] 设计牌局记录数据模型（历史记录、回放数据）
- [ ] MongoDB集合结构设计
- [ ] 数据库索引优化
- [ ] 数据验证规则（Joi）

#### 2.2 服务端核心游戏逻辑
**时间**: 8-10天
- [ ] **牌类系统**：Card类、CardDeck类、花牌逻辑
- [ ] **房间管理系统**：创建房间、加入/离开房间、房间状态管理
- [ ] **游戏流程控制**：开局、发牌、补花、出牌轮次
- [ ] **玩家操作验证**：出牌、吃碰杠、胡牌合法性检查
- [ ] **胡牌判断算法**：基本牌型、特殊牌型（清一色、对对胡等）
- [ ] **宁海麻将特殊规则**：
  - 第一圈只能打筒万限制
  - 三摊规则和包牌逻辑
  - 花牌对应位置加番
- [ ] **计分系统**：四种计分模式（幺半三、幺半六、推倒八、幺二六）
- [ ] **游戏状态同步**：实时广播游戏状态变化
- [ ] **断线重连系统**：
  - 状态版本控制和快照机制
  - 操作队列和确认机制
  - 增量状态更新
  - 离线操作缓存
- [ ] **状态版本控制系统**：游戏状态版本管理、状态历史记录
- [ ] **断线重连支持**：玩家离线检测、状态快照保存、重连状态恢复

#### 2.3 客户端游戏逻辑
**时间**: 6-7天
- [ ] **牌类显示系统**：牌的渲染、排序、分组
- [ ] **玩家操作处理**：点击出牌、拖拽操作、操作按钮
- [ ] **游戏状态同步**：接收服务端状态、更新本地显示
- [ ] **操作提示系统**：可出牌提示、可操作提示
- [ ] **胡牌检测**：客户端辅助检测（服务端为准）
- [ ] **动画系统基础**：出牌动画、发牌动画
- [ ] **音效触发**：操作音效、提示音效
- [ ] **断线重连界面处理**：
  - 重连状态提示界面
  - 渐进式状态恢复动画
  - 离线操作缓存和重放
  - 网络状态监听和处理
- [ ] **断线重连处理**：网络状态监听、重连逻辑、状态恢复
- [ ] **离线操作缓存**：离线时操作缓存、重连后操作同步

### 第三阶段：用户界面与交互（3周）

#### 3.1 UI界面设计与实现
**时间**: 8-10天
- [ ] **登录界面**：微信登录、游客登录、用户协议
- [ ] **大厅界面**：用户信息展示、快速开始、创建房间、加入房间
- [ ] **房间列表界面**：房间筛选、房间信息展示、观战功能
- [ ] **游戏主界面**：
  - 牌桌布局（四人位置）
  - 手牌区域
  - 出牌区域
  - 操作按钮区域
  - 玩家信息显示
  - 花牌显示区域
- [ ] **设置界面**：音效开关、音乐开关、画质设置
- [ ] **战绩界面**：历史记录、详细数据、分享功能
- [ ] **结算界面**：胡牌展示、分数计算、继续游戏

#### 3.2 游戏交互系统
**时间**: 6-7天
- [ ] **牌操作交互**：
  - 点击选牌/出牌
  - 拖拽出牌
  - 牌的高亮显示
  - 手牌自动排序
- [ ] **游戏操作界面**：
  - 吃碰杠操作弹窗
  - 胡牌确认界面
  - 操作倒计时显示
  - 操作历史显示
- [ ] **社交功能**：
  - 快捷聊天
  - 表情系统
  - 语音聊天（可选）
- [ ] **辅助功能**：
  - 操作提示
  - 新手引导
  - 规则说明

#### 3.3 动画与特效系统
**时间**: 4-5天
- [ ] **基础动画**：
  - 发牌动画（从牌堆到玩家）
  - 出牌动画（从手牌到桌面）
  - 补花动画
  - 吃碰杠动画
- [ ] **特殊效果**：
  - 胡牌庆祝动画
  - 特殊牌型提示效果
  - 粒子特效（胡牌、特殊操作）
  - 屏幕震动效果
- [ ] **UI动画**：
  - 界面切换动画
  - 按钮点击反馈
  - 弹窗出现/消失动画

### 第四阶段：微信公众号集成与优化（2周）

#### 4.1 微信公众号网页适配
**时间**: 5-6天
- [ ] **微信公众号配置**：
  - 公众号开发者配置
  - 域名白名单配置
  - 网页授权域名设置
- [ ] **微信网页授权登录**：
  - OAuth2.0网页授权流程
  - 用户信息获取（昵称、头像）
  - openid/unionid绑定系统
- [ ] **微信JS-SDK集成**：
  - 分享到朋友圈和微信群
  - 分享给朋友功能
  - 微信支付（如需要）
  - 获取地理位置
  - 调用微信扫一扫
- [ ] **微信网页特性适配**：
  - 微信浏览器兼容性
  - 微信内置浏览器特殊处理
  - 防止页面被缓存
  - 微信分享参数配置

#### 4.2 性能优化
**时间**: 4-5天
- [ ] **资源优化**：
  - 图片压缩和格式优化
  - 音频压缩
  - 资源分包加载
  - 预加载策略
- [ ] **代码优化**：
  - 代码分割和懒加载
  - 内存泄漏检查和修复
  - 对象池管理
  - 垃圾回收优化
- [ ] **网络优化**：
  - 请求合并和缓存
  - 断线重连优化
  - 数据压缩传输
- [ ] **渲染优化**：
  - 批处理渲染
  - 纹理合并
  - 动画性能优化

#### 4.3 兼容性与适配
**时间**: 3-4天
- [ ] **设备适配**：
  - 不同屏幕尺寸适配（iPhone、Android各种尺寸）
  - 不同分辨率适配
  - 横屏/竖屏适配
  - 刘海屏和异形屏适配
- [ ] **浏览器兼容性**：
  - 微信内置浏览器兼容性
  - iOS Safari兼容性
  - Android Chrome兼容性
  - 不同微信版本测试
- [ ] **网络环境测试**：
  - 弱网环境测试
  - 网络切换测试
  - 离线重连测试
  - HTTPS证书配置

### 第五阶段：测试与部署（2周）

#### 5.1 测试阶段
**时间**: 7-8天
- [ ] **单元测试**：
  - 服务端业务逻辑测试
  - 胡牌算法测试
  - 计分系统测试
  - API接口测试
- [ ] **集成测试**：
  - 客户端-服务端通信测试
  - 数据库操作测试
  - 第三方API集成测试
- [ ] **功能测试**：
  - 完整游戏流程测试
  - 边界条件测试
  - 异常情况处理测试
  - 多人同时游戏测试
  - 断线重连功能测试
    - 网络中断恢复测试
    - 状态同步准确性测试
    - 操作队列重放测试
    - 界面恢复完整性测试
- [ ] **性能测试**：
  - 并发用户压力测试
  - 内存使用测试
  - 网络延迟测试
  - 长时间运行稳定性测试
- [ ] **用户体验测试**：
  - 真实用户测试
  - 界面易用性测试
  - 游戏平衡性测试

#### 5.2 部署与运维
**时间**: 5-6天
- [ ] **容器化部署**：
  - Docker镜像构建
  - Docker Compose配置
  - 容器编排和管理
- [ ] **服务器配置**：
  - Nginx反向代理配置
  - SSL证书配置
  - 防火墙和安全配置
  - 负载均衡配置（如需要）
- [ ] **监控系统**：
  - 服务器监控（CPU、内存、磁盘）
  - 应用监控（响应时间、错误率）
  - 数据库监控
  - 日志收集和分析
- [ ] **CI/CD流水线**：
  - 自动化构建
  - 自动化测试
  - 自动化部署
  - 回滚机制

#### 5.3 上线准备
**时间**: 2-3天
- [ ] **微信审核准备**：
  - 小游戏提交审核
  - 审核材料准备
  - 版本管理
- [ ] **运营准备**：
  - 用户手册编写
  - 客服系统准备
  - 数据统计系统
  - 反馈收集机制

## 断线重连技术实现方案

### 核心技术架构

#### 1. 状态同步技术
- **服务端状态快照**: 维护完整游戏状态，支持版本控制
- **增量更新机制**: 只传输状态变化部分，减少网络开销
- **状态版本控制**: 每次状态变化增加版本号，支持状态回滚
- **操作确认机制**: 客户端操作需要服务端确认，确保数据一致性

#### 2. 界面更新技术
- **观察者模式**: 状态变化自动触发界面更新
- **虚拟DOM差异**: 计算界面差异，只更新变化部分
- **批量更新**: 合并多个状态变化，减少界面刷新次数
- **渐进式恢复**: 分步骤恢复界面，提升用户体验

#### 3. 网络通信优化
- **心跳检测**: 定期检测网络连接状态
- **自动重连**: 网络断开后自动尝试重连
- **操作队列**: 缓存未发送的操作，重连后重新发送
- **超时重试**: 操作超时后自动重试，防止操作丢失

#### 4. 用户体验优化
- **离线提示**: 网络断开时显示离线状态
- **重连进度**: 显示重连进度和状态恢复进度
- **平滑过渡**: 状态恢复时使用动画过渡，避免界面突变
- **操作预测**: 本地预测操作结果，减少等待时间

### 技术实现细节

#### 服务端实现
```javascript
// 状态版本管理
class GameStateVersioning {
    updateState(gameId, newState) {
        this.stateVersion++;
        const versionedState = {
            ...newState,
            version: this.stateVersion,
            timestamp: Date.now()
        };
        this.broadcastStateUpdate(gameId, versionedState);
        return versionedState;
    }
}

// 断线重连处理
class ReconnectHandler {
    async handleReconnect(playerId, gameId) {
        const gameState = await this.getGameState(gameId);
        const playerState = await this.getPlayerState(playerId);
        return { gameState, playerState };
    }
}
```

#### 客户端实现
```typescript
// 状态恢复管理器
class StateRecoveryManager {
    async recoverGameState() {
        const serverState = await NetworkManager.requestGameState();
        const diff = this.calculateStateDiff(this.localState, serverState);
        await this.applyStateDifference(diff);
    }
}

// 断线重连管理器
class ReconnectManager {
    async handleReconnect() {
        this.showReconnectingUI();
        await this.establishConnection();
        await StateRecoveryManager.recoverGameState();
        this.hideReconnectingUI();
    }
}
```

## 断线重连技术方案

### 1. 状态同步架构

#### 1.1 服务端状态管理
- **状态版本控制**：每次状态变更增加版本号
- **状态快照机制**：定期保存完整游戏状态
- **增量更新**：记录状态变化历史，支持增量同步
- **操作确认机制**：客户端操作需要服务端确认

#### 1.2 客户端状态恢复
- **本地状态缓存**：缓存最后已知的游戏状态
- **操作队列**：缓存未确认的用户操作
- **状态差异计算**：比较本地和服务端状态差异
- **渐进式恢复**：分步骤恢复游戏状态和界面

### 2. 界面更新技术

#### 2.1 观察者模式更新
```typescript
// 事件驱动的界面更新系统
EventManager.on('reconnect:success', (gameState) => {
    // 批量更新所有界面元素
    this.batchUpdateAllUI(gameState);
});
```

#### 2.2 虚拟状态差异更新
- **虚拟DOM概念**：维护虚拟游戏状态
- **差异计算**：计算需要更新的界面部分
- **批量更新**：减少界面更新次数，提升性能
- **平滑过渡**：使用动画实现状态切换

### 3. 网络通信优化

#### 3.1 WebSocket连接管理
- **心跳检测**：定期发送心跳包检测连接状态
- **自动重连**：连接断开后自动尝试重连
- **重连策略**：指数退避算法，避免频繁重连
- **连接状态提示**：实时显示网络连接状态

#### 3.2 数据传输优化
- **消息确认**：重要操作需要服务端确认
- **消息去重**：避免重复处理相同消息
- **数据压缩**：压缩传输数据减少带宽占用
- **优先级队列**：重要消息优先传输

### 4. 用户体验设计

#### 4.1 重连过程用户提示
- **连接状态指示器**：实时显示网络状态
- **重连进度提示**：显示重连和状态恢复进度
- **离线模式提示**：网络断开时的友好提示
- **操作缓存提示**：告知用户操作已缓存

#### 4.2 状态恢复动画
- **淡入淡出效果**：界面元素平滑出现
- **进度条动画**：状态恢复进度可视化
- **卡牌飞入动画**：手牌恢复的动画效果
- **状态同步提示**：同步完成的视觉反馈

## 详细开发任务

### 服务端开发任务

#### 1. 项目结构
```
server/
├── src/
│   ├── controllers/     # 控制器
│   ├── models/         # 数据模型
│   ├── routes/         # 路由
│   ├── services/       # 业务逻辑
│   ├── utils/          # 工具函数
│   ├── middleware/     # 中间件
│   └── socket/         # Socket.io处理
├── config/             # 配置文件
├── tests/              # 测试文件
└── package.json
```

#### 2. 核心模块开发
- **用户管理模块**
  - 用户注册/登录
  - 用户信息管理
  - 好友系统

- **房间管理模块**
  - 创建/加入房间
  - 房间状态管理
  - 观战功能

- **游戏逻辑模块**
  - 发牌逻辑
  - 出牌验证
  - 胡牌判断
  - 计分系统

- **实时通信模块**
  - Socket.io事件处理
  - 消息广播
  - 断线重连系统
    - 心跳检测机制
    - 自动重连策略
    - 状态恢复处理
    - 操作队列管理机制
  - 心跳检测
  - 操作确认机制
  - 状态同步优化

#### 3. API接口设计
```javascript
// 用户相关
POST /api/auth/login      // 登录
POST /api/auth/register   // 注册
GET  /api/user/profile    // 获取用户信息
PUT  /api/user/profile    // 更新用户信息

// 房间相关
GET  /api/rooms           // 获取房间列表
POST /api/rooms           // 创建房间
POST /api/rooms/:id/join  // 加入房间
POST /api/rooms/:id/leave // 离开房间

// 游戏相关
GET  /api/game/:id/state        // 获取游戏状态
POST /api/game/:id/action       // 游戏操作
GET  /api/game/history          // 游戏历史
GET  /api/game/:id/sync/:version // 获取指定版本后的状态变化
POST /api/game/:id/reconnect    // 断线重连请求
GET  /api/game/:id/actions/pending // 获取未确认的操作
```

### 客户端开发任务

#### 1. 项目结构
```
client/
├── assets/
│   ├── scenes/         # 场景文件
│   ├── scripts/        # 脚本文件
│   ├── textures/       # 贴图资源
│   ├── audio/          # 音频资源
│   └── prefabs/        # 预制体
├── settings/           # 项目设置
└── build/              # 构建输出
```

#### 2. 核心系统开发
- **场景管理系统**
  - 场景切换
  - 场景预加载
  - 场景数据传递

- **网络通信系统**
  - WebSocket连接管理
  - 消息队列和确认机制
  - 断线重连系统
    - 连接状态监听
    - 自动重连逻辑
    - 重连进度提示
    - 网络状态指示器
  - 数据同步系统
    - 状态版本控制
    - 增量状态更新
    - 本地状态缓存
    - 操作重放机制
  - 操作队列管理
  - 网络状态监听
  - 自动重连策略

- **游戏逻辑系统**
  - 牌类管理
  - 玩家操作
  - 游戏状态
  - 动画控制

- **UI系统**
  - 界面管理
  - 弹窗系统
  - 适配系统
  - 国际化

#### 3. 主要场景设计
- **启动场景**: Logo展示、资源预加载
- **登录场景**: 用户登录、微信授权
- **大厅场景**: 房间列表、个人信息、设置
- **游戏场景**: 麻将游戏主界面
- **结算场景**: 游戏结果展示

### 数据库设计

#### 用户表 (users)
```javascript
{
  _id: ObjectId,
  openid: String,        // 微信openid
  nickname: String,      // 昵称
  avatar: String,        // 头像URL
  coins: Number,         // 游戏币
  level: Number,         // 等级
  exp: Number,           // 经验值
  winCount: Number,      // 胜局数
  loseCount: Number,     // 败局数
  totalGames: Number,    // 总局数
  createdAt: Date,
  updatedAt: Date
}
```

#### 房间表 (rooms)
```javascript
{
  _id: ObjectId,
  roomId: String,        // 房间号
  name: String,          // 房间名称
  maxPlayers: Number,    // 最大玩家数
  currentPlayers: Number, // 当前玩家数
  gameMode: String,      // 游戏模式
  scoringMode: String,   // 计分模式
  status: String,        // 房间状态
  players: [ObjectId],   // 玩家列表
  owner: ObjectId,       // 房主
  createdAt: Date,
  updatedAt: Date
}
```

#### 游戏记录表 (games)
```javascript
{
  _id: ObjectId,
  roomId: String,
  players: [{
    userId: ObjectId,
    position: Number,    // 座位位置
    cards: [String],     // 手牌
    score: Number,       // 得分
    isWinner: Boolean    // 是否胜利
  }],
  gameData: Object,      // 游戏详细数据
  duration: Number,      // 游戏时长
  createdAt: Date
}
```

## 开发工具和环境

### 开发环境
- **Node.js**: v16+
- **MongoDB**: v5.0+
- **Cocos Creator**: v3.8+
- **微信开发者工具**: 最新版

### 开发工具
- **IDE**: VS Code
- **版本控制**: Git
- **API测试**: Postman
- **数据库管理**: MongoDB Compass
- **项目管理**: Trello/Jira

## 部署方案

### 服务器配置
- **云服务器**: 阿里云/腾讯云
- **操作系统**: Ubuntu 20.04
- **容器化**: Docker + Docker Compose
- **反向代理**: Nginx
- **SSL证书**: Let's Encrypt

### 部署流程
1. 代码提交到Git仓库
2. CI/CD自动构建Docker镜像
3. 自动部署到测试环境
4. 测试通过后部署到生产环境
5. 监控系统状态和性能

## 风险评估与应对

### 技术风险
- **网络延迟**: 实现断线重连和状态同步
- **性能问题**: 代码优化和资源管理
- **兼容性**: 多设备测试和适配

### 业务风险
- **用户体验**: 持续优化UI和交互
- **游戏平衡**: 数据分析和调整
- **安全性**: 防作弊和数据加密

## 关键里程碑

### 里程碑1：基础架构完成（第2周末）
- 服务端和客户端基础框架搭建完成
- 数据库设计完成
- 基础通信功能正常

### 里程碑2：核心游戏逻辑完成（第5周末）
- 完整的麻将游戏逻辑实现
- 宁海麻将特殊规则实现
- 基础UI界面完成

### 里程碑3：完整功能实现（第8周末）
- 所有游戏功能完成
- UI/UX完善
- 基础测试通过

### 里程碑4：微信集成完成（第10周末）
- 微信小游戏适配完成
- 性能优化完成
- 兼容性测试通过

### 里程碑5：上线准备完成（第12周末）
- 所有测试完成
- 部署环境就绪
- 微信审核材料准备完成

## 时间线总览
- **第1-2周**: 项目搭建与基础架构
- **第3-5周**: 核心游戏逻辑开发
- **第6-8周**: 用户界面与交互开发
- **第9-10周**: 微信集成与优化
- **第11-12周**: 测试与部署
- **总开发周期**: 12周（约3个月）

## 风险评估与应对策略

### 技术风险
1. **Cocos Creator学习曲线**
   - 风险：团队对Cocos Creator不熟悉
   - 应对：提前学习，准备技术储备

2. **实时通信复杂性**
   - 风险：多人游戏状态同步复杂
   - 应对：采用成熟的Socket.io方案，充分测试

3. **断线重连技术挑战**
   - 风险：状态同步不一致，界面恢复不完整
   - 应对：
     - 实现完善的状态版本控制
     - 建立操作确认和重放机制
     - 充分测试各种网络环境
     - 设计降级方案（重新加载游戏）

3. **微信小游戏限制**
   - 风险：微信平台限制和审核要求
   - 应对：提前了解微信开发规范，预留审核时间

### 业务风险
1. **需求变更**
   - 风险：开发过程中需求频繁变更
   - 应对：前期充分沟通需求，建立变更管理流程

2. **性能要求**
   - 风险：游戏性能不达标
   - 应对：分阶段性能测试，及时优化

### 时间风险
1. **开发进度延期**
   - 风险：某个阶段开发时间超出预期
   - 应对：设置缓冲时间，关键路径管理

## 资源需求

### 人力资源
- **后端开发**: 1人（Node.js开发经验）
- **前端开发**: 1人（Cocos Creator经验）
- **UI设计**: 1人（游戏UI设计经验）
- **测试**: 1人（游戏测试经验）
- **项目管理**: 1人

### 硬件资源
- **开发设备**: 高配置开发机器
- **测试设备**: 多种型号手机和平板
- **服务器**: 云服务器（开发、测试、生产环境）

### 软件资源
- **开发工具**: Cocos Creator、VS Code、微信开发者工具
- **设计工具**: Photoshop、Sketch等
- **项目管理**: Git、项目管理工具

## 成功指标

### 技术指标
- **响应时间**: 游戏操作响应时间 < 100ms
- **并发支持**: 支持1000+同时在线用户
- **稳定性**: 99.9%可用性，无严重崩溃bug
- **兼容性**: 支持95%以上主流设备

### 用户体验指标
- **加载时间**: 游戏启动时间 < 3秒
- **流畅度**: 游戏运行帧率稳定在30fps以上
- **易用性**: 新用户能在5分钟内学会基本操作

### 业务指标
- **功能完整性**: 100%核心功能实现
- **微信审核**: 一次性通过微信小游戏审核
- **用户留存**: 首日留存率 > 60%
